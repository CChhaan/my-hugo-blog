---
title: "1. 异步：现在与将来"
date: 2025-08-20T19:49:53
draft: false
---

### 一、分块的程序与异步机制

1. **分块程序的本质**：
   将代码包装为函数并指定其响应某个事件执行时，即创建了 “将来执行的块”，由此引入异步机制 —— 代码不再按顺序同步执行，而是分阶段在不同时间点运行。
2. **console.log 的异步特性**：
   部分浏览器的`console.log`并非立即输出内容，因 IO 操作通常低速且阻塞，浏览器会后台异步处理控制台 IO 以提升性能，可能导致输出顺序与代码执行顺序不一致。

### 二、事件循环

1. **核心机制**：
   事件循环是处理程序中多个代码块执行的机制，通过调用 JS 引擎依次执行块。循环的每一轮称为一个**tick**：
   - 若队列中有等待事件（即回调函数），则从队列中取出一个执行；
   - 无事件时，循环等待新事件加入。
2. **setTimeout 的作用**：
   并非直接将回调函数加入事件循环队列，而是设定定时器：当定时器到期后，宿主环境会将回调函数放入事件循环队列，等待未来某个 tick 执行。

### 三、并行执行

1. **异步与并行的区别**：
   - 异步：关注 “现在与将来的时间间隙”（代码块在不同时间点执行）；
   - 并行：关注 “同时发生”（多个操作在物理上同时进行）。
2. **进程与线程**：
   - 进程和线程独立运行，可能并行执行，多线程可共享单个进程的内存；
   - JS 通过 “单线程事件循环” 避免共享内存的并行访问 / 修改，但可通过多线程的事件循环协作实现并行与顺序执行共存。
3. **JS 的单线程特性**：
   - 函数代码具有**原子性**（完整运行特性）：一旦函数开始执行，会在其他代码运行前完成（无中断）；
   - 若函数执行顺序不确定，可能导致**竞态条件**（因共享状态的修改顺序不可控引发的逻辑错误）。

### 四、并发

1. **定义**：
   两个或多个进程（虚拟进程 / 任务，即逻辑相关的运算序列）“同时执行”，无论单个运算是否并行。可理解为 “进程级的并行”，与 “运算级的并行” 相对。

2. **JS 的并发形式**：
   单线程事件循环是并发的一种形式 ——JS 一次只能处理一个事件，不会严格 “同时” 执行，但多个任务可交替在事件循环中运行。

3. **并发交互的协调方式**：

   - 门（Gate）：等待多个条件都满足后再执行下一步。例如：

     ```js
     function foo(x) {
       a = x * 2;
       if (a && b) baz(); // 需a和b都准备好才调用baz()
     }
     ```
     
   - 门闩（Latch）：“只有第一名取胜”，仅首次满足条件时执行。例如：
   
     ```js
     function foo(x) {
       if (!a) { // 仅a未被赋值时执行
         a = x * 2;
         baz();
       }
     }
     ```
     
   - 并发协作：将长期运行的进程拆分为多步 / 多批任务，允许其他并发进程插入事件循环交替运行。例如：处理长列表时，用```setTimeout(..., 0)```
   
     将任务拆分为异步步骤，避免阻塞 UI：
   
     ```js
     // 协作式处理长列表
     function processList(list, index = 0) {
       if (index >= list.length) return;
       // 处理当前项
       handleItem(list[index]);
       // 异步调度下一项，让事件循环有机会处理其他任务
       setTimeout(() => processList(list, index + 1), 0);
     }
     ```

### 五、任务队列（Task Queue）

- 任务队列挂在事件循环每个 tick 之后：在事件循环的某个 tick 中，异步动作（如 Promise 回调）不会添加新事件到事件循环队列，而是在当前 tick 的任务队列末尾添加项目，确保在本轮 tick 结束前执行，优先级高于下一轮 tick 的事件。