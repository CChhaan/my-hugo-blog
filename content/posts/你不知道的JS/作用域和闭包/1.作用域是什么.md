---
title: "1.作用域是什么"
date: 2025-08-20T19:49:53
draft: false
---

> 本文总结《你不了解的JS》第一部分第一章的核心概念，重点介绍了JavaScript的编译原理和作用域机制。笔记指出程序状态通过变量存储和访问实现，作用域是一套管理变量的规则体系。编译过程包括分词、语法分析和代码生成三个阶段。在变量赋值时，编译器处理声明，引擎执行查询（LHS/RHS）。作用域嵌套时，引擎会逐级向上查找变量。文章还区分了RHS和LHS查询的区别，以及在不同情况下可能出现的ReferenceError和TypeError异常。严格模式会改变LHS查询失败时的默认行为。

### 一、核心概念

1. **程序状态与变量**：存储和访问变量值的能力为程序赋予了状态。
2. **作用域定义**：一套规则体系，用于管理变量的存储方式和查找逻辑，确保代码能按规则访问变量。

---

### 二、编译原理

1. 传统编译三阶段：
   - **分词 / 词法分析**：将源代码字符串分解为有意义的词法单元（如关键字、变量名、运算符等）。
   - **解析 / 语法分析**：将词法单元流转换为抽象语法树（AST），AST 是体现程序语法结构的嵌套树状结构。
   - **代码生成**：将 AST 转换为可执行代码。
2. **JavaScript 编译特点**：多数情况下，编译在代码片段执行前的几微秒内完成（即时编译）。

---

### 三、作用域的核心角色

- **引擎**：负责整个 JavaScript 程序的编译及执行全过程。
- **编译器**：负责语法分析、代码生成等编译相关工作。
- **作用域**：负责收集并维护所有声明的标识符（变量、函数名等），并制定规则确定当前执行的代码对这些标识符的访问权限。

### 四、变量声明与赋值过程（以`var a = 2`为例）

1. 变量声明（编译器处理）：
   - 编译器询问当前作用域：是否已存在名为`a`的变量。
   - 若存在，忽略该声明；若不存在，要求作用域在当前集合中声明一个新变量`a`。
2. 变量赋值（引擎处理）：
   - 引擎询问当前作用域：是否存在名为`a`的变量。存在则直接使用，不存在则继续向上查找。
   - 找到`a`后，将 2 赋值给它；未找到则抛出异常。
3. LHS 与 RHS 查询：
   - **RHS 查询**：查找变量的值（如`console.log(a)`中对`a`的查询）。
   - **LHS 查询**：查找变量的容器本身，用于赋值（如`a = 2`中对`a`的查询）。
4. **函数声明处理**：编译器在代码生成阶段同步处理函数的声明和值定义。

---

### 五、作用域嵌套

1. **嵌套场景**：当块或函数嵌套在另一个块或函数中时，形成作用域嵌套。
2. 查找规则：
   - 引擎从当前执行作用域开始查找变量，找不到则向上一级嵌套作用域继续查找。
   - 直至找到变量或抵达全局作用域，查找过程终止。

---

### 六、异常类型及触发场景

1. ReferenceError（引用错误）：
   - RHS 查询：在所有嵌套作用域中未找到目标变量时抛出。
   - LHS 查询：严格模式下，在所有作用域中未找到目标变量时抛出（非严格模式下会自动在全局作用域创建该变量，`let`/`const`本身在非严格模式下也不会隐式创建全局变量）。
2. **TypeError（类型错误）**：RHS 查询找到变量，但对其值进行不合理操作（如对非函数变量调用方法）时抛出。

