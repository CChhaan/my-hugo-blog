---
title: "附录 混合环境Js"
date: 2025-08-20T19:49:53
draft: false
---

### 一、Annex B（ES 规范的兼容性补充）

1. **背景**：
   ECMAScript（ES）是 JS 的官方规范，Annex B 专门定义因浏览器兼容性问题导致的与官方规范的差异，主要针对浏览器环境的 JS 实现。

2. **主要兼容性差异**：

   - 非严格模式允许**八进制数值常量**（如`012`，严格模式下为语法错误）；

   - 浏览器提供`window.escape()`和`window.unescape()`，用于转义 / 还原带`%`分隔符的十六进制字符串（非标准方法，建议避免使用）；

     ```String.prototype.substr```与```String.prototype.substring```
   
     的区别：

     - `substring(start, end)`：第二个参数为结束位置索引（不包含该位置）；
     - `substr(start, length)`：第二个参数为截取长度。
   
3. **Web ES 规范的额外差异**：

   - `<!--`和`-->`被视为合法单行注释分隔符；
   - `String.prototype`包含返回 HTML 格式字符串的附加方法（如`anchor()`、`bold()`）；
   - 正则表达式（RegExp）扩展及`Function.prototype`附加方法（非标准，依赖浏览器实现）。

### 二、宿主对象

1. **定义**：由宿主环境（如浏览器、Node.js）创建并提供给 JS 引擎的对象 / 函数（如`window`、`document`、`console`），包括内建对象和工具函数。
2. **特殊行为差异**：
   - 部分宿主对象强制转换为布尔值时可能为**假值**（如`document.all`，不符合 JS 标准假值规则）；
   - 其他特性：
     - 可能无法访问普通`Object`的内建方法（如`toString()`）；
     - 部分属性为只读，无法覆盖；
     - 方法的`this`无法重绑定到其他对象。
3. **console 对象**：
   - 宿主环境提供的输出工具，浏览器中输出到开发控制台，Node.js 中指向标准输出（stdout）和标准错误输出（stderr）。

### 三、全局 DOM 对象

1. **全局变量与 global 对象**：声明全局变量会同时在全局对象（如浏览器的`window`）中创建同名属性。
2. **DOM 元素 ID 的副作用**：因浏览器历史遗留问题，带`id`属性的 DOM 元素会自动创建同名全局变量（如`<div id="app">`会生成`window.app`）。

### 四、原生原型扩展的注意事项

1. **不建议扩展原生原型**：除非确保无代码冲突（如第三方库可能覆盖扩展方法）。
2. **扩展原则**：扩展原生方法时需添加判断（如`if (!Array.prototype.includes) { ... }`），避免覆盖已有功能。
3. polyfill 与 shim：
   - **shim**：带兼容性测试的代码，用于填补环境差异（如检查功能是否存在，不存在则提供替代实现）；
   - polyfill：只检查功能是否存在，不进行兼容性测试
   - **pollyfill**：特殊的 shim，专为实现未被环境支持的标准功能而设计，需与未来标准兼容（如为老浏览器实现`Array.prototype.includes`）。

### 五、script 标签与代码加载

1. **多文件 / 内联代码的运行特性**：
   - 多个`script`标签（外部文件或内联代码）共享全局对象，在同一命名空间交互，但**全局作用域的提升机制不跨文件边界**（即一个文件的变量不会提升到另一个文件）。
   - 单个`script`出错会停止自身执行，但不影响后续`script`运行。
2. **动态创建 script**：通过 JS 动态创建`<script>`标签并插入 DOM，效果与静态标签一致，可用于动态加载外部文件。
3. **内联代码的特殊限制**：内联代码中不能直接出现`</script>`（会被视为代码块结束），变通方法为拆分字符串（如`"<sc"+"ript>"`）。
4. **字符集差异**：
   - 外部文件通过`script`标签的`charset`属性指定解析字符集；
   - 内联代码使用所在页面的字符集，且内联`script`无`charset`属性。

### 六、保留字

1. 定义：ES5 规范定义的不可用作变量名的标识符，包括四类：

   - 关键字（如`if`、`function`）；
   - 预留关键字（如`class`、`enum`）；
   - 常量（`null`、`true`、`false`）。
   
2. **放宽限制**：ES5 之前，保留字不能作为对象属性名；现在允许（如`const obj = { class: 1 }`合法）。

### 七、引擎实现的限制

JS 规范未统一限制以下内容，但不同引擎实现存在差异：

- 字符串常量的最大字符数（非字符串值本身）；
- 函数参数的数据大小（栈大小限制）；
- 函数声明的参数个数；
- 未优化的调用栈最大层数（函数调用链长度）；
- 浏览器中 JS 程序的最长阻塞运行时间（避免页面卡顿）；
- 变量名的最大长度。
