### 1. **类型缩小与控制流分析基础**

- TS 会跟踪代码执行路径（如`if/else`、`switch`、循环等），分析变量在不同分支中的具体类型。

- 类型保护：特殊表达式（如`typeof x === 'string'`），TS 可通过它判断变量类型，从而缩小类型范围。

- 类型缩小：通过类型保护或赋值操作，将变量类型从 “宽泛”（如联合类型）收缩为 “具体”（如单一类型）的过程。


### 2. **基于** **typeof** **运算符的类型缩小**

- TS 可识别`typeof`的 8 种返回值：`"string"`、`"number"`、`"bigint"`、`"boolean"`、`"symbol"`、`"undefined"`、`"object"`、`"function"`。

- typeof检查是一种类型保护，TypeScript 编码了typeof对不同值的操作逻辑，包括其在 JavaScript 中的一些特性。

### 3. **基于真值检查的类型缩小**

- JavaScript 中，if等构造会将条件强制为布尔值，0、NaN、""（空字符串）、0n（bigint版本零）、null、undefined强制为false，其他值强制为true。

- 可通过Boolean函数或双布尔否定（!!）将值强制为布尔值，后者的优势是 TypeScript 会推断出缩小的字面布尔类型true，而前者推断为boolean类型。

- 利用这种行为防范null或undefined很常见，带有!的布尔否定会从否定分支中过滤掉这些值。

### 4. **基于相等性检查的类型缩小**

- TypeScript 使用switch语句和===、!==、==、!=等相等性检查来缩小类型。

- == null不仅检查值是否为null，还检查是否为undefined；== undefined同样检查值是null还是undefined。

### 5. **基于** **in** **运算符的类型缩小**

- JavaScript 的in运算符用于确定对象或其原型链是否具有指定名称的属性。

- TypeScript 将in运算符视为缩小潜在类型的方式：对于"value" in x（"value"为字符串字面，x为联合类型），“true” 分支会缩小x为具有可选或必需属性value的类型，“false” 分支缩小为具有可选或缺少属性value的类型。

### 6. **基于** **instanceof** **的类型缩小**

- 检查值的原型链是否包含构造函数的`prototype`，适用于`new`创建的对象

- instanceof是类型保护，TypeScript 会在instanceof保护的分支中缩小类型。

### 7. **基于赋值的类型缩小**

- 变量赋值后，TS 会根据赋值内容缩小其类型。

### 8. **用户定义的类型保护**

- 定义方式：创建返回类型为类型谓词的函数，谓词形式为parameterName is Type，其中parameterName必须是当前函数签名中的参数名称。

### 9. **可区分的联合**

- 联合类型中的每个成员都包含一个**字面量类型的公共属性**（如`type`字段），用于区分不同类型，TypeScript 将其视为可区分的联合，可通过检查该属性缩小联合的成员范围，switch语句中也适用这种检查。

### 10. **never** **类型与穷尽检查**

- 缩小类型时，若联合的选项被全部消除，会得到never类型，表示不应该存在的状态。

- never类型可分配给所有类型，但没有类型（除自身外）可分配给never。利用这一点，可通过缩小范围依靠never在switch语句中进行穷尽检查，确保联合类型的所有成员都被处理。

#### 类型缩小方法对比

| **方法**       | **适用场景**                 | **示例**                            |
| :------------- | :--------------------------- | :---------------------------------- |
| `typeof`       | 基本类型区分                 | `typeof value === "string"`         |
| 真值检查       | 过滤假值（null/undefined等） | `if (value)`                        |
| 相等性检查     | 精确值匹配                   | `x === y`                           |
| `in` 操作符    | 对象属性检查                 | `"prop" in obj`                     |
| `instanceof`   | 类实例区分                   | `obj instanceof Date`               |
| 赋值           | 变量重新赋值时               | `let x = init; x = "new"`           |
| 自定义类型保护 | 复杂类型验证                 | `function isFish(pet): pet is Fish` |
| 可区分联合     | 联合类型精确缩小             | `switch (obj.kind)`                 |