---
# 文章标题
title: 3.2 IP 协议相关技术
# 文章内容摘要
# description:
# 文章内容关键字
keywords: DNS, 域名解析, 根域名服务器, 顶级域名服务器, 权威DNS服务器, ARP, MAC地址解析, RARP, DHCP, DHCP中继代理, NAT, NAPT, IPv4地址转换, NAT穿透, ICMP, ICMP差错报文, 网络诊断, IGMP, 组播协议, 组播组管理, 网络层协议, TCP/IP协议族, IP地址分配, 网络通信, DNS缓存, DHCP租期, 网络地址转换技术
# 发表日期
date: 2025-09-26
summary: 本节详细介绍了 IP 协议相关技术，包括 DNS、ARP、DHCP 和 NAT。
# 分类
categories:
  - 计算机网络
# 标签
tags:
  - 计算机基础
  - 计算机网络
  - IP
---

## DNS

DNS：将域名网址自动转换为具体的 IP 地址的系统。

### 域名的层级关系

域名使用句点（.）分隔，越靠右层级越高。

层级结构类似树状：

- 根 DNS 服务器
- 顶级域 DNS 服务器（例如 .com）
- 权威 DNS 服务器（例如 server.com）

根域 DNS 服务器信息保存在所有 DNS 服务器中，因此任何 DNS 服务器都能找到根域服务器，客户端只需找到任意一台 DNS 服务器，即可层层查找目标服务器。

### 域名解析的工作流程

浏览器检查自身缓存 → 操作系统缓存 → 本机 hosts 文件。

若都无结果，则开始向 DNS 服务器查询：

- 客户端向 本地 DNS 服务器 发送请求，询问 www.server.com 的 IP。
- 若本地 DNS 有缓存结果，直接返回 IP；若无则向 根域名服务器 查询。
- 根域名服务器根据域名后缀（如 .com），返回对应 顶级域名服务器地址。
- 本地 DNS 再询问顶级域名服务器。
- 顶级域名服务器返回该域的 权威 DNS 服务器地址。
- 本地 DNS 继续询问权威 DNS 服务器。
- 权威 DNS 服务器 返回 www.server.com 对应的 IP 地址。
- 本地 DNS 将结果返回给客户端，客户端与目标主机建立连接。

## ARP

当主机确定了源 IP 与目标 IP 后，会通过路由表确定**下一跳 IP 地址**。为了在数据链路层传输，还需知道**下一跳的 MAC 地址**。主机通过 ARP 协议向网络请求并获取目标的 MAC 地址。

**ARP** 用于在已知 IP 地址的情况下，**获取对应的 MAC 地址**。

### ARP 确定 MAC 地址的过程

主机通过广播发送 ARP 请求包，包内包含目标主机的 IP 地址。

同一链路上的设备收到请求后检查目标 IP 是否与自己匹配。若匹配，则将自身 **MAC 地址** 填入 ARP 响应包，返回给请求方。

操作系统会**缓存第一次获取的 MAC 地址**，以便下次使用。MAC 缓存有有效期，过期后将被清除。

### RARP 协议

**RARP**与 ARP 相反，**已知 MAC 地址求 IP 地址**。

流程：

- 网络中架设 RARP 服务器，注册设备的 MAC 与 IP 映射。
- 设备接入网络后，发送请求：“我的 MAC 地址是 XXXX，请告诉我对应的 IP 地址。”
- RARP 服务器收到请求后，返回应答：“MAC 地址为 XXXX 的设备，其 IP 地址是 XXXX。”
- 设备依据应答信息设置自身 IP 地址。

## DHCP

**DHCP**：用于**自动分配 IP 地址及网络配置参数**的协议。客户端监听 **68 端口**，服务器监听 **67 端口**。

DHCP 工作流程：

- **DHCP Discover（发现）**：客户端无 IP 地址，也不知道服务器位置。通过 **UDP 广播通信** 发送发现报文：目的地址：`255.255.255.255:67`；源地址：`0.0.0.0:68`，广播传递至网络中所有设备。
- **DHCP Offer（提供）**：DHCP 服务器接收请求后，用广播地址响应，报文内容包含：可租用的 IP 地址、子网掩码、默认网关、DNS 服务器、IP 地址租期
- **DHCP Request（请求）**：客户端从收到的多个 Offer 中选择一个服务器。向选中的服务器发送请求报文，确认选择。
- **DHCP ACK（确认）**：服务器用 ACK 报文应答，确认分配的参数。客户端收到后，即可在租期内使用该 IP 地址。

租期到期前，客户端发送 DHCP Request 请求：

- 若服务器同意，回复 **DHCP ACK**，延长租期。
- 若服务器拒绝，回复 **DHCP NACK**，客户端必须停止使用该 IP。

整个 DHCP 交互过程均使用 UDP 广播通信。

### DHCP 中继代理

若 DHCP 服务器与客户端不在同一局域网内，路由器不会转发广播包。为了解决这一问题，就出现了 DHCP 中继代理：

- 客户端向 DHCP 中继代理发送请求。
- 中继代理接收广播包后，将其以单播形式转发至 DHCP 服务器。
- 服务器向中继代理返回应答。
- 中继代理再以广播形式转发应答至客户端。

即使不在同一链路，DHCP 服务器也能实现统一的 IP 地址分配与管理。

## NAT

网络地址转换（NAT）是一种缓解 **IPv4 地址耗尽** 问题的技术。

**NAT**：在同一公司、家庭或教室内，主机对外通信时，将 **私有 IP 地址** 转换为 **公有 IP 地址** 的技术。

**NAPT**：由于大多数网络应用使用 TCP 或 UDP 协议，可以将 **IP 地址 + 端口号** 一起进行转换，从而 **使用一个全球 IP 地址** 实现多主机外网通信。

NAT 路由器通过 **自动生成转换表** 来管理地址与端口的对应关系。

### 缺点

NAT/NAPT 都依赖自己的转换表，因此存在以下问题：

- 外部无法主动与 NAT 内部服务器建立连接（因无转换记录）。
- 转换表的生成与转换操作会产生性能开销。
- 若 NAT 路由器重启，所有 TCP 连接将被重置。

### 解决 NAT 潜在问题的方法

1. 使用 IPv6：

IPv6 地址空间极大，每台设备都可分配公有 IP 地址，因此不需要地址转换，但 **IPv6 普及仍需时间**。

2. NAT 穿透技术：

NAT 穿透技术可让应用程序主动：发现自己位于 NAT 设备之后，获取 NAT 设备的公有 IP，为自己建立端口映射条目。

该过程由 **NAT 设备后的应用程序自动完成**：应用程序主动配合 NAT 设备，自行建立映射，使用该条目对外通信，不再需要 NAT 设备进行转换。

## ICMP（互联网控制报文协议）

### 功能

ICMP 的主要功能包括：确认 IP 包是否成功送达目标地址；报告 IP 包在传输中被废弃的原因；改善网络设置。

当 IP 包未能到达目标地址时，ICMP 负责通知具体原因。

### 类型

ICMP 报文分为两类：

- **查询报文类型**：用于诊断（查询消息）。
- **差错报文类型**：用于通知出错原因（错误消息）。

## IGMP（因特网组管理协议）

**IGMP**：用于主机（组播成员）与最后一跳路由器之间的通信。

主要功能：主机通过 IGMP 报文 **申请加入或退出组播组**。路由器默认不转发组播包，只有当主机通过 IGMP 加入组播组后，路由器才会转发。

**封装与特征**：使用 IP 封装，IP 头部协议号为 **2**，**TTL = 1**，仅限于主机与连接的路由器间通信。

### IGMP 工作机制

IGMP 分为三个版本：**IGMPv1、IGMPv2、IGMPv3**

常规查询与响应工作机制

- 路由器周期性发送 **目的地址为 224.0.0.1** 的 IGMP 常规查询报文（同网段所有主机和路由器）。
- 主机收到查询后启动 **报告延迟计时器**（随机 0 ～ 10 秒）。
- 计时器超时后，主机发送 **成员关系报告报文**：源 IP：主机自身地址；目的 IP：组播地址。
- 若在计时器超时前收到同组其他主机的报告，则不再发送（避免重复）。
- 路由器收到报告后，在 IGMP 路由表中加入该组播组，后续转发对应数据包。

离开组播组的情况一，网段中仍有该组播组成员：

- 主机 1 离开组 **224.1.1.1**，发送 **IGMPv2 离组报文**（目的地址：224.0.0.2，表示所有路由器）。
- 路由器收到后，每隔 1 秒连续发送 2 次 **特定组查询报文**，确认是否仍有成员。
- 主机 3 仍为该组成员，立即响应查询。
- 路由器确认组仍存在，继续转发 224.1.1.1 的组播数据包。

离开组播组的情况二，网段中无该组播组成员：

- 主机 1 离开组 **224.1.1.1**，发送 IGMP 离组报文。
- 路由器收到后，每隔 1 秒发送 2 次特定组查询报文。
- 若无主机响应，路由器判断该组已不存在。**停止向该网段转发该组播地址的数据包**。
