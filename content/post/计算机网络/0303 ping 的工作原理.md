---
# 文章标题
title: 3.3 ping 的工作原理
# 文章内容摘要
# description:
# 文章内容关键字
keywords: ICMP协议, ping命令, traceroute命令, ICMP报文类型, 查询报文, 差错报文, 目标不可达消息, 超时报文, 重定向消息, 原点抑制消息, TTL, 路由追踪, 网络诊断, 网络层协议, IP包丢失, 网络拥塞控制, MTU路径发现, ARP解析, MAC地址, UDP端口不可达
# 发表日期
date: 2025-09-27
summary: 本节详细介绍了 ping 的工作原理，包括 ICMP 协议、ICMP 消息类型、ping 命令的工作流程等。
# 分类
categories:
  - 计算机网络
# 标签
tags:
  - 计算机基础
  - 计算机网络
  - IP
---

## ICMP（互联网控制报文协议）

### 功能

ping 是基于 ICMP 协议工作的，ICMP 的主要功能包括：确认 IP 包是否成功送达目标地址；报告 IP 包在传输中被废弃的原因；改善网络设置。

当 IP 包未能到达目标地址时，ICMP 负责通知具体原因。

### 类型

ICMP 报文分为两类：

- **查询报文类型**：用于诊断（查询消息）
- **差错报文类型**：用于通知出错原因（错误消息）

### 查询报文类型

回送消息用于主机或路由器之间判断数据包是否成功到达对端。 **ping 命令** 即利用该消息实现。

可以向对端主机发送 **回送请求消息**（类型 8），也可以接收对端主机发回的 **回送应答消息**（类型 0）。

报文结构新增字段

- **标识符**：用于区分发出 ICMP 包的应用程序，例如使用进程 PID 作为标识符。
- **序号**：从 0 开始，每次发送新的请求加 1，用于确认网络包是否丢失。
- **选项数据**：`ping` 命令会在其中存放发送请求的时间值，用以计算往返时间，反映通信路程长短

### 差错报文类型

#### 目标不可达消息

**类型**：3

**作用**：当路由器无法将 IP 数据包发送给目标地址时，返回该消息，说明 **不可达的具体原因**。

| 错误类型             | 代码 | 含义                                                                 |
| :------------------- | :--: | -------------------------------------------------------------------- |
| 网络不可达           |  0   | 路由表匹配不到接收方 IP 的网络号；因不再有网络分类，该错误较少使用。 |
| 主机不可达           |  1   | 路由表中无主机信息或主机未连接网络。                                 |
| 协议不可达           |  2   | 对端主机存在，但防火墙禁止该协议访问。                               |
| 端口不可达           |  3   | 对端主机存在且防火墙允许，但端口无进程监听。                         |
| 需分片但设置不分片位 |  4   | 路由器遇到超过 MTU 的包且分片位为 1，丢弃并返回该错误。              |

#### 原点抑制消息

**类型**：4

**作用**：在低速广域线路（WAN）出现拥堵时，用于缓和网络流量。

机制：当路由器的发送队列缓存为零、无法继续发送时，向 IP 包源地址发送 **原点抑制消息**。主机接收后得知线路某处发生拥堵，从而 **增大发送间隔**，减少网络流量。

由于可能导致通信不公平，该类型消息一般 **不被使用**。

#### 重定向消息

**类型**：5

**作用**：当路由器发现主机未使用最优路径发送数据时，返回 **重定向消息**，内容包含最合适的路由信息和源数据，告知发送端下次应将数据发给更合适的路由器。

#### 超时消息

**类型**：11

**触发条件**：IP 包的 **TTL（Time To Live，生存周期）** 减为 0 时。

**作用**：通知发送端主机该 IP 包已被丢弃。

TTL 机制：每经过一个路由器，TTL 值减 1。

TTL 的主要作用：

- **防止路由循环**导致数据包无限转发；
- **控制包的到达范围**，例如设置较小的 TTL 限制传输距离。

## ping —— 查询报文类型的使用

1. **构建 ICMP 回送请求消息** ：

   - **类型字段**：8（回送请求）
   - **序号**：用于区分连续 ping 时的多个数据包，每次发出请求时序号自动加 1
   - **发送时间**：插入报文数据部分，用于计算往返时间 RTT

2. **IP 层构建数据包**

   - 目标 IP
   - 源 IP：本机 IP
   - 协议字段：1，表示 ICMP 协议

3. **MAC 地址解析** ：检查 ARP 映射表获取目标 IP 的 MAC 地址 ，若无映射，发送 ARP 请求以获取目标 MAC 地址，构建数据链路层数据帧，并传输

4. **接收与响应**

- 主机 B 接收到数据帧后，检查 MAC 地址，并将 IP 数据包交给 ICMP 协议

- 主机 B 构建 ICMP 回送响应消息（类型字段为 0，序号与请求消息一致），返回给主机 A

5. **结果判断**

- 若源主机未收到 ICMP 响应消息，则目标主机不可达
- 若收到响应，则目标主机可达
- 计算往返时间 RTT：当前时刻减去发出时刻

**跨网段情况**需要涉及网关和路由器的转发，ICMP 报文头不受影响，主要影响的是路由选择和 MAC 地址更新

## traceroute —— 差错报文类型的使用

### 作用 1：追踪路径

**目标**：通过设置 TTL 跟踪目的地路径中经过的路由器

原理：

- 设置 TTL 从 1 开始递增，每经过一个路由器 TTL 值减 1
- 每次 TTL 为 1 时，遇到第一个路由器，丢弃数据包并返回 ICMP 超时报文
- TTL 增加至 2，继续经过第一个路由器，直到到达目标主机
- 通过该过程获取所有经过的路由器 IP

**局限性**：

- 有些路由器可能不返回 ICMP 超时报文，导致无法显示所有路由
- 有时，因公网路由器的限制，无法查看中间经过的路由

发送 UDP 包与端口检测：

**UDP 包发送**：使用不可能的端口号（如 33434）作为目标端口号，每次探针发送时，目标端口号递增

**目的主机响应**：目标主机收到 UDP 包后，若端口不可达，则返回 ICMP 差错报文（端口不可达），**端口不可达**的 ICMP 报文表示 UDP 包已成功到达目的主机。

### 作用 2：确定路径的 MTU

**目标**：通过故意设置不分片，发现路径的 MTU（最大传输单元）

**作用**：通过逐步减少包大小，确定适合的 MTU，避免数据包在传输过程中被丢弃。

**工作原理**：

- 发送端在 IP 包首部设置不分片标志（标志位为 1），禁止路由器进行分片
- 如果路由器遇到大于 MTU 的数据包，直接丢弃并返回 ICMP 不可达消息（类型为“需要分片但设置了不分片位”）
- 发送主机接收到该消息后，减少包的大小，直到找到适合的 MTU 值
