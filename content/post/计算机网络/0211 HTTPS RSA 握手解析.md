---
# 文章标题
title: 2.11 HTTPS RSA 握手解析
# 文章内容摘要
# description:
# 文章内容关键字
keywords: TLS 握手, HTTPS 加密, RSA 握手过程, TLS 密钥交换, Client Hello, Server Hello, 数字证书, CA 认证, 证书链, pre-master, 会话密钥, RSA 加密, 非对称加密, 对称加密, HTTPS 安全机制, 前向保密, ECDHE 密钥协商, TLS 加密通信, HTTPS 安全原理
# 发表日期
date: 2025-09-24
summary: 本节详细解析 HTTPS 的 RSA 握手过程，包括 TLS 握手过程、RSA 握手过程、客户端验证证书等。
# 分类
categories:
  - 计算机网络
# 标签
tags:
  - 计算机基础
  - 计算机网络
  - HTTP协议
---

## TLS 握手过程

**HTTP 明文传输的风险：**：窃听风险、篡改风险、冒充风险

**HTTPS 的解决方案：**在 HTTP 与 TCP 层之间加入 **TLS 协议**，通过以下方式保障安全：**信息加密**、**校验机制**、**身份证书**

TLS 握手是建立安全通信的前提。通常通过 **四个消息（2 个 RTT）** 完成握手。不同的密钥交换算法会导致握手过程存在差异。

TLS 记录是数据收发的基本单位，类似 TCP 的 segment。

HTTPS 作为应用层协议，需先建立 TCP 连接，再执行 TLS 握手。

数据加密使用 **对称加密密钥**，性能较高。对称密钥需通过 **非对称加密** 保护其协商过程。**密钥交换算法** 负责保护对称密钥的安全性。

## RSA 握手过程

传统 TLS 握手多使用 **RSA 算法** 进行密钥交换。

服务端证书文件即为 **公钥**。服务端的 **私钥** 仅保存在服务端，必须防止泄漏。

客户端生成随机密钥，用服务端公钥加密后传给服务端。服务端用私钥解密，双方获得相同密钥以加密应用消息。

### 第一次握手：Client Hello

客户端发送 **Client Hello** 消息，内容包括：TLS 版本号、支持的密码套件列表、随机数（**Client Random**），该随机数是生成对称加密密钥的材料之一。

### 第二次握手：Server Hello

服务端收到消息后：确认 TLS 版本号是否支持，从客户端提供的密码套件中选择一个，生成随机数（**Server Random**）。

随后返回 **Server Hello** 消息，包含：确认的 TLS 版本号，随机数（Server Random）选定的密码套件。

**密码套件格式**：「密钥交换算法 + 签名算法 + 对称加密算法 + 摘要算法」，其中第一个单词表示 **密钥交换算法**，第二个单词表示 **证书验证算法**

客户端与服务端完成：

- TLS 版本和密码套件确认
- 双方各自生成并交换随机数，用于生成 **会话密钥**

服务端随后发送：

- **Server Certificate**（包含数字证书）
- **Server Hello Done**（表示打招呼完毕）

### 客户端验证证书

#### 数字证书和 CA 机构

**数字证书内容：**公钥、持有者信息、证书认证机构（CA）信息、CA 的数字签名及算法、证书有效期、其他附加信息

**作用：**认证公钥持有者身份，防止冒充。

**CA**：负责签发并验证证书，签名可防止中间人篡改证书内容。

#### 数字证书签发和验证流程

数字证书签发流程：

- CA 将公钥、用途、颁发者、有效期等信息打包。
- 对信息进行 Hash 计算，得到 Hash 值。
- 使用 **CA 私钥** 加密该 Hash 值，生成 **Certificate Signature**。
- 将 Signature 添加至文件中，形成数字证书。

客户端验证流程：

- 客户端使用相同 Hash 算法计算证书的 Hash 值 **H1**。
- 使用内置的 **CA 公钥** 解密 Certificate Signature，得到 **H2**。
- 比较 **H1 与 H2**：相同：证书可信；不同：证书不可信

#### 证书链

证书通常由中间证书签发，而非根证书，根证书被严格隔离以保证安全，若根证书泄露，整个信任链都会失效。

### 第三次握手：Client Key Exchange

客户端验证证书后，若可信则继续：生成新的随机数 **pre-master**，使用服务器 RSA 公钥加密后，通过 **Client Key Exchange** 发送。

服务端使用 RSA 私钥解密，得到 **pre-master**。

双方此时拥有三个随机数：**Client Random**、**Server Random**、**pre-master**

双方根据三个随机数生成 **会话密钥（Master Secret）**，即对称加密密钥。

客户端发送：

- **Change Cipher Spec**：通知开始加密传输。
- **Encrypted Handshake Message（Finished）**：用会话密钥加密前面所有握手数据的摘要，供服务端验证。

「Change Cipher Spec」之前为明文传输，之后为对称加密的密文。

### 第四次握手：Server Finished

服务端发送：**Change Cipher Spec**、**Encrypted Handshake Message**

双方验证加解密正确后，握手完成，之后使用 **会话密钥** 加密 HTTP 请求与响应。

## RSA 算法的缺陷

最大问题：**不支持前向保密**。

客户端传递随机数时使用公钥加密，服务端用私钥解密。一旦服务端私钥泄漏，过去被截获的所有 TLS 通讯密文都能被破解。

为解决此问题，出现了 **ECDHE 密钥协商算法**。目前大多数网站使用的正是 **ECDHE 算法**。
