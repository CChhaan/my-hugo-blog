---
# 文章标题
title: 2.14 HTTP/2
# 文章内容摘要
# description:
# 文章内容关键字
keywords: HTTP/2 性能优化, HTTP/1.1 性能问题, HTTP/2 多路复用, HPACK 头部压缩, 二进制帧, Stream 流, HTTP 队头阻塞, 服务器推送, PUSH_PROMISE 帧, HTTP/2 并发传输, Huffman 编码, 动态表压缩, 静态表编码, HTTP 报文优化, TCP 慢启动, HTTP 延迟优化, HTTP 头部压缩算法, HTTP 协议升级, HTTP/2 兼容性, 网络传输优化
# 发表日期
date: 2025-09-25
summary: 本节详细介绍 HTTP/2 协议，包括其性能问题、兼容性、头部压缩、二进制帧、并发传输等内容。
# 分类
categories:
  - 计算机网络
# 标签
tags:
  - 计算机基础
  - 计算机网络
  - HTTP协议
---

## HTTP/1.1 协议的性能问题

**延迟难以下降**：网络带宽虽然增加，但延迟降到一定幅度后难以再降低，已到达延迟下限。

**并发连接有限**：谷歌浏览器最大并发连接数：**6 个**，每个连接都需要经历 **TCP 与 TLS 握手**，并受 **TCP 慢启动**影响。

**队头阻塞问题**：同一连接中只能在完成一个 HTTP 事务（请求与响应）后，才能处理下一个事务。

**HTTP 头部巨大且重复**：每个请求都需携带完整 HTTP 头部，Cookie 通常较大，造成带宽浪费。

**不支持服务器推送消息**：客户端需定时拉取通知，浪费带宽和服务器资源。

## 兼容 HTTP/1.1

**URI 保持一致**：仍使用 `http://` 表示明文协议， `https://` 表示加密协议。浏览器与服务器可在后台自动升级，实现**平滑过渡**。

**仅修改应用层语法**：传输层仍基于 **TCP 协议**。**语义层（方法、状态码、头字段）保持一致**。仅**语法层**进行重新设计，改变了报文传输格式。

## 头部压缩

HTTP 报文结构为 **Header + Body**。HTTP/1.1 仅可通过 `Content-Encoding` 压缩 Body，Header 无优化手段。

Header 的问题：

- 含有大量固定字段（可达数百字节甚至上千字节）。
- 字段值重复，占用大量带宽。
- 使用 **ASCII 编码**，效率低。

HTTP/2 的改进：HPACK 算法

HPACK 由三部分组成：**静态字典**、**动态字典**、**Huffman 编码**

客户端与服务器各自维护字典，用索引号替代重复字符串，再用 Huffman 编码压缩，压缩率可达 **50%~90%**。

### 静态表编码

预定义高频字段，写入 HTTP/2 框架中，不会变化。

通过 **Index（索引号）** 表示字段名和值。

若字段值可变，则使用 **Huffman 编码**后再发送。

按 RFC7541 标准，静态表字段的二进制头部前两位为 `01`。

二进制编码取代文本格式，不再使用冒号与 `\r\n` 作为分隔符，而使用 **字符串长度（Value Length）**区分。

### 动态表编码

用于静态表未覆盖的字段，**Index 从 62 开始**。

首次传输时会 Huffman 编码，之后双方更新动态表。再次传输同字段时，仅需发送 1 字节索引号。

前提：必须在同一连接上重复传输完全相同的头部。

若字段值频繁变化，则动态表无法充分利用。

动态表越大，占用内存越多，影响性能。

可通过 `http2_max_requests` 限制每个连接的请求数量，以释放内存。

## 二进制帧

HTTP/2 将 HTTP/1 的文本报文改为二进制格式，大幅提高传输与解析效率。

每条 HTTP 响应由多个 **帧（Frame）**组成，**帧头（Frame Header）**占 **9 字节**。

| 字节数    | 含义                               |
| --------- | ---------------------------------- |
| 前 3 字节 | 帧数据长度（Frame Payload Length） |
| 第 4 字节 | 帧类型（Frame Type，共 10 种）     |
| 第 5 字节 | 标志位（Flags，8 位）              |
| 后 4 字节 | 流标识符（Stream ID，31 位）       |

#### 常见标志位

- `END_HEADERS`：头数据结束。
- `END_STREAM`：单向数据结束。
- `PRIORITY`：流的优先级。

帧数据中存放 **HPACK 压缩后的 Header 与 Body**。

## 并发传输

HTTP/1.1：请求-响应模型导致队头阻塞。

HTTP/2：通过 **Stream** 实现多路复用。

Stream 层级关系：

- **一个 TCP 连接**可包含 **多个 Stream**。
- **Stream** 内包含 **一个或多个 Message**。
- **Message** 由 **多个 Frame** 构成，Frame 是 HTTP/2 的最小传输单元。

不同 Stream 的帧可**乱序发送**，通过 Stream ID 重新组装。同一 Stream 内帧必须**有序传输**。

**客户端 Stream ID：奇数号**；**服务器 Stream ID：偶数号**。

Stream ID 不可复用，递增至上限后需通过 `GOAWAY` 帧关闭连接。

HTTP/2 仅需建立 **一次 TCP 连接** 支持多 Stream，避免多次 TCP/TLS 握手与慢启动。

可为不同 Stream 设置 **优先级**，优化传输顺序。

## 服务器主动推送资源

HTTP/1.1：仅客户端主动请求。

HTTP/2：服务器可主动推送资源。

客户端请求使用 **奇数号 Stream**，服务器推送使用 **偶数号 Stream**，推送时通过 **PUSH_PROMISE 帧**传输头部信息，通过 **Promised Stream ID** 指明后续传输的 Stream。

服务器可在客户端请求 HTML 时，**主动推送 CSS 文件**，减少请求往返次数。
