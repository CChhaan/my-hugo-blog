---
# 文章标题
title: 2.12 HTTPS ECDHE 握手解析
# 文章内容摘要
# description:
# 文章内容关键字
keywords: 离散对数, DH 算法, DHE 算法, ECDHE 密钥协商, ECDHE 算法原理, 椭圆曲线加密, TLS 握手过程, 前向安全性, 密钥交换, 非对称加密, 会话密钥, Client Hello, Server Hello, Client Key Exchange, Server Finished, RSA 签名, TLS False Start, TLS 安全通信, HTTPS 加密原理, ECDHE 优势
# 发表日期
date: 2025-09-24
summary: 本节详细解析 HTTPS ECDHE 握手过程，包括客户端和服务端如何交换密钥，以及如何生成会话密钥。
# 分类
categories:
  - 计算机网络
# 标签
tags:
  - 计算机基础
  - 计算机网络
  - HTTP协议
---

## 离散对数

**ECDHE 密钥协商算法** 是 **DH 算法** 的演进版本。

**DH 算法** 是一种 **非对称加密算法**，可用于 **密钥交换**。该算法的核心数学思想是 **离散对数**。

**对数运算** 的取值是连续的，**离散对数** 的取值是离散的。

离散对数是在对数运算的基础上加入了 **模运算（取余数）**。

公式结构：底数：`a`、模数：`p`（为公共参数，公开）、真数：`b`、对数：`i`

若已知对数，可通过公式计算出真数，但反之，若只知道真数，计算对数极其困难。

当 **模数 p 是一个很大的质数** 时，即使已知底数 a 和真数 b，在现有计算机水平下几乎无法算出离散对数。这正是 **DH 算法的数学基础**。

## DH 算法

**确定公开参数：**选择模数 `P` 和底数 `G`。

**生成私钥：**双方各自生成随机整数作为私钥（`a` 与 `b`），私钥需严格保密。

**计算公钥：**公钥是公开的。

- 客户端：`A = G ^ a ( mod P )`
- 服务端：`B = G ^ b ( mod P )`

**计算共享密钥：**因离散对数幂运算具有交换律，双方计算结果相同，即 **K 为会话密钥**。

- 客户端计算：`K = B ^ a ( mod P )`
- 服务端计算：`K = A ^ b ( mod P )`

## DHE 算法

DH 算法根据私钥生成方式分为两种实现：

- **Static DH 算法**（已废弃）
- **DHE 算法**（现常用）

Static DH 的问题： 一方（通常为服务端）的私钥是静态的，即固定不变。客户端的私钥每次协商随机生成。 随着时间推移，黑客可截获大量协商数据，并暴力破解出服务器私钥，从而推算出历史会话密钥。 因此，**Static DH 不具备前向安全性**。

DHE 的改进：“E” 表示 **ephemeral（临时性的）**。双方在每次通信时，**私钥均随机生成、临时使用**。每次通信过程的私钥独立无关，从而实现 **前向安全**。

## ECDHE 算法

**DHE 算法性能较差**（计算量大），因此演进出 **ECDHE 算法**（利用椭圆曲线特性）。ECDHE 能以更少计算量生成公钥和会话密钥。

算法步骤：

- **确定公共参数：**椭圆曲线种类、椭圆曲线基点 **G**（二者均为公开参数）
- **生成密钥对：**双方各自生成随机数作为私钥 **d**，计算公钥 **Q = dG**
- **交换公钥：**双方交换各自的公钥。
- **计算共享密钥：**客户端计算：`(x1, y1) = d1Q2`服务端计算：`(x2, y2) = d2Q1`因椭圆曲线满足交换律：`d1Q2 = d1d2G = d2d1G = d2Q1`，双方得到相同的 **x 坐标**，即 **会话密钥**。

双方的私钥均为 **随机、临时生成且不公开**。

即使知道椭圆曲线、公钥、基点 G，也难以求出私钥（离散对数问题困难）。

## ECDHE 握手过程

使用 ECDHE 时，客户端在 **第四次握手前** 就可发送加密数据。相比 RSA 握手，减少一次往返时间。

该机制称为 **“TLS False Start”**，类似于 **“TCP Fast Open”**，提升传输效率。

### TLS 第一次握手（Client Hello）

客户端发送 **Client Hello** 消息，内容包括：TLS 版本号、支持的密码套件列表，随机数 **Client Random**。

### TLS 第二次握手（Server Hello）

服务端返回 **Server Hello** 消息，内容包括：确认的 TLS 版本号、随机数 **Server Random**、从客户端列表中选择的密码套件

随后发送：

1. **Certificate**（服务器证书）
2. **Server Key Exchange**

- 选择椭圆曲线（确定基点 G）并公开
- 生成随机数作为服务端私钥
- 计算并公开服务端椭圆曲线公钥
- 使用 **RSA 签名算法** 对公钥签名，防止篡改

3. **Server Hello Done**

此时客户端与服务端共享以下明文信息：Client Random、Server Random、椭圆曲线与基点 G、服务端椭圆曲线公钥，这些将作为生成会话密钥的材料。

### TLS 第三次握手（Client Key Exchange）

客户端验证证书合法性（证书链验证 + 签名验证），生成随机数作为客户端私钥，根据服务端信息计算客户端公钥，通过 **Client Key Exchange** 消息发送公钥给服务端。

双方计算点 `(x, y)`，其中 **x 坐标相同**，作为共享密钥材料。

最终会话密钥由以下三部分生成：客户端随机数、服务端随机数、ECDHE 算法计算所得的共享密钥（x）

此设计可增强随机性与安全性。

之后客户端发送：

- **Change Cipher Spec**：通知改用对称加密。
- **Encrypted Handshake Message**：验证对称密钥是否可用。

### TLS 第四次握手（Server Finished）

服务端同样发送：

- **Change Cipher Spec**
- **Encrypted Handshake Message**

双方验证加解密正确后，握手完成，开始安全传输加密的 **HTTP 请求与响应**。
