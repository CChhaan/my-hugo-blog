---
# 文章标题
title: 3. 缩小
# 文章内容摘要
# description:
# 文章内容关键字
keywords: TypeScript 类型缩小, TypeScript 类型保护, TypeScript type guard, TypeScript narrowing, typeof 类型保护, instanceof 缩小, in 操作符缩小, 相等缩小, TypeScript 控制流分析, TypeScript 类型谓词, TypeScript is 语法, 区分联合类型, discriminated unions, TypeScript never 类型, TypeScript 穷尽性检查, TypeScript 类型推断, TypeScript 自定义类型保护
# 发表日期
date: 2025-07-22
summary: 本文主要介绍了 TypeScript 中的缩小，包括 typeof 类型保护、真实性缩小、相等缩小、in 操作符缩小、instanceof 缩小、赋值、控制流分析、类型谓词、区分联合类型等。
# 分类
categories:
  - typescript文档阅读
# 标签
tags:
  - TypeScript
  - 前端开发
---

TypeScript 会将类型分析覆盖在 JavaScript 的运行时控制流结构上，例如 `if/else`、条件表达式、循环、真值检查等，这些结构都会影响类型判断。

当 TypeScript 看到如 `typeof padding === "number"` 的检查时，会将其识别为一种称为**类型保护（Type Guard）**的特殊代码形式。TypeScript 会跟踪程序可能的执行路径，分析各位置值的最具体类型，并通过这些检查和赋值将类型细化为更具体的类型，这一过程称为**缩小（Narrowing）**。

## typeof 类型保护

JavaScript 的 `typeof` 操作符能在运行时提供值的类型信息。

TypeScript 能理解 `typeof` 的结果，用以在不同分支中缩小类型范围。

TypeScript 内置了对 `typeof` 的行为规则，因此能正确处理 JavaScript 的一些特例。

## 真实性缩小

在 JavaScript 中，`if`、`&&`、`||`、`!` 等条件语句可以接受任意类型的表达式。

条件判断时会先将表达式强制为 `boolean`，再根据结果选择分支。

可通过：`Boolean(value)`或 `!!value`将值强制为布尔类型。

这种方式常用于防范 `null` 或 `undefined`。但对原始值的真值检查容易出错，TypeScript 仅能在有限范围内帮助发现问题。

带有 `!` 的布尔否定会从否定分支中过滤掉原值。

## 相等缩小

TypeScript 会利用 `switch`、`===`、`!==`、`==`、`!=` 来缩小类型。

即使使用宽松等式（`==`、`!=`），TypeScript 也能正确缩小。

- `x == null` 同时检查 `x` 是否为 `null` 或 `undefined`。
- `x == undefined` 亦同理。

## in 操作符缩小

JavaScript 的 `in` 操作符可判断某对象或其原型链中是否存在指定属性。TypeScript 利用此信息缩小可能的类型范围。

**可选属性**在缩小时会同时存在于两侧分支。

## instanceof 缩小

`instanceof` 用于检查某值是否是另一构造函数的实例。

TypeScript 将其视为一种类型保护，可根据结果缩小分支类型。

`x instanceof Foo` 会检查 `x` 的原型链中是否包含 `Foo.prototype`。

## 赋值

当变量被赋值时，TypeScript 会根据右侧值缩小左侧变量的类型。

变量的**声明类型**始终是校验基准：

- 可以赋值为声明类型的任一成员；
- 但不能赋值为声明类型之外的类型。

```ts
let x = Math.random() < 0.5 ? 10 : "hello world!";
x = 1; // OK
x = "goodbye!"; // OK
x = true; // Error
```

## 控制流分析

TypeScript 会基于代码**可达性（reachability）**执行控制流分析。

它跟踪变量在每个执行路径中的类型变化。

类型保护与赋值会导致变量类型在不同代码点分离或重新合并。

## 类型谓词

**类型谓词**允许开发者定义自定义的类型守卫

```ts
function isFish(pet: Fish | Bird): pet is Fish {
  return (pet as Fish).swim !== undefined;
}
```

语法：`parameterName is Type`，其中参数名必须是当前函数参数。

使用该函数后，TypeScript 会在分支中自动缩小类型：

```ts
let pet = getSmallPet();

if (isFish(pet)) {
  pet.swim();
} else {
  pet.fly();
}
```

类中也可使用 `this is Type` 来缩小类型。

## 区分联合类型

当联合类型的各成员都有一个共同的字面量属性时，TypeScript 会将其识别为**区分联合类型**。

TypeScript 会根据该属性自动缩小类型范围。

```ts
interface Circle {
  kind: "circle";
  radius: number;
}

interface Square {
  kind: "square";
  sideLength: number;
}

type Shape = Circle | Square;

function getArea(shape: Shape) {
  switch (shape.kind) {
    case "circle":
      return Math.PI * shape.radius ** 2;
    case "square":
      return shape.sideLength ** 2;
  }
}
```

这种检查也适用于 `switch` 语句，可帮助避免错误分支跳转。

## never 类型

当类型缩小后排除了所有可能性时，TypeScript 会使用 **`never`** 表示此“不应存在”的状态。

## 穷尽性检查

`never` 可以赋值给任何类型；

但**没有任何类型可以赋值给 `never`**（除 `never` 自身）。

因此，可利用 `never` 在 `switch` 中进行**穷尽性检查**，确保所有情况都被覆盖。
