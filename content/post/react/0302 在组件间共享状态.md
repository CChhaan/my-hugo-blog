---
# 文章标题
title: 3.2 在组件间共享状态
# 文章内容摘要
# description: 本文详细介绍了 Git 这一分布式版本控制系统的优点，对比了 Windows 与 macOS/Linux 系统下的常用命令，讲解了 vim 操作模式及常用命令，还阐述了 Git 的基本配置、特定项目配置和命令缩写设置等内容。
# 文章内容关键字
keywords: React 状态提升, state lifting, 受控组件, 非受控组件, 单一数据源, React 状态管理, 渲染树, React 组件位置, state 保留规则, key 重置 state, React 状态重置, 状态丢失问题, 组件状态共享, 状态提升方案, React UI 树, 组件隐藏保留状态, localStorage 初始化状态, React 性能与状态设计
# 发表日期
date: 2025-10-14
summary: 本文介绍了在 React 组件间共享状态的方法，包括状态提升、可信单一数据源、状态与渲染树中的位置关系、在相同位置重置 state 以及为被移除的组件保留 state 等内容。
# 分类
categories:
  - React文档阅读
# 标签
tags:
  - react
  - 前端框架
  - 前端开发
  - 组件化开发
---

## 状态提升

三个步骤：

1. **从子组件中移除状态**
2. **从公共父组件传递硬编码数据**
3. **为公共父组件添加状态**

非受控组件：包含“不受控制”状态的组件。更简单，但组合使用时不够灵活。

受控组件：组件中的重要信息由 `props` 驱动，而不是自身状态。**灵活性最大**，但需要父组件通过 `props` 进行配置。

## 每个状态都对应唯一的数据源

**对于每个独特的状态，都应该存在且只存在于一个指定的组件中作为 state。**这一原则称为：**可信单一数据源**。

对于每个状态，需要一个专门的组件来保存它。应当**将状态提升** 到公共父级，或**将状态传递** 到需要它的子级。不应在组件之间复制共享的状态。

随着应用操作变化，状态位置也可能会发生变化。当你将状态上下移动时，需要重新确定状态“活跃”的位置。

## 状态与渲染树中的位置相关

React 为 UI 创建渲染树。状态是由 React 保存的，并与组件在树中的位置相关。

**只有在树中相同的位置渲染相同的组件时，React 才会保留 state。**

当组件被移除或替换成不同组件时，state 会被销毁。

- 相同位置渲染相同组件，state 保留

  **对 React 来说关键是组件在 UI 树中的位置，而非在 JSX 中的位置。**React 不关心代码中的条件逻辑，只关心最终渲染出的树。

- 相同位置渲染不同组件，state 重置

  不同组件会导致整个子树重置，包括 state。

如果你想在重新渲染时保留 state，多次渲染的树结构应保持一致。不一致的结构会导致 state 被销毁。

**永远将组件定义在最上层，不要嵌套定义组件。**嵌套定义会导致 bug 和性能问题。

## 在相同位置重置 state

重置 state 的两种方法：

1. **将组件渲染在不同的位置**
2. **使用 `key` 为每个组件赋予独立身份**

`key` 的行为：`key` 使 React 根据 key 来识别组件而不是位置顺序。`key` **只在父组件内部有效**，不是全局唯一。使用 `key` 重置 state 在表单场景中尤其常见。

## 为被移除的组件保留 state

- 不移除组件，只隐藏：渲染所有组件，通过 CSS 隐藏不显示的部分。组件未从树中移除，因此内部 state 会保留下来。
- 状态提升：将状态提升到父组件进行保存。子组件可被移除，但重要信息由父组件保留。
- 其他数据源：使用 `localStorage` 初始化组件 state。
