---
# 文章标题
title: 4.4节 生成器
# 文章内容摘要
# description: 本文详细介绍了 Git 这一分布式版本控制系统的优点，对比了 Windows 与 macOS/Linux 系统下的常用命令，讲解了 vim 操作模式及常用命令，还阐述了 Git 的基本配置、特定项目配置和命令缩写设置等内容。
# 文章内容关键字
keywords: JavaScript, 生成器，Generator, yield, 迭代器，异步迭代，Promise 结合，yield*
# 发表日期
date: 2025-08-13
# 摘要
summary: 本文详解JavaScript生成器概念、特性及异步应用，展示其如何简化异步流程，实现同步写法与异步执行。
# 分类
categories:
  - 你不知道的JS
# 标签
tags:
  - JavaScript
  - ECMAScript
  - 前端开发
---

## 生成器的基本概念与特性

1. **定义与控制方式**：
   - 生成器是一类特殊函数，声明方式为`function*`（函数名前加`*`），可暂停、恢复执行，不一定需要完成。
   - 通过迭代器控制生成器：调用生成器函数（如`*foo()`）会返回一个迭代器对象（如`it`），通过`it.next()`启动或恢复生成器执行，直至下一个`yield`或结束。
2. **`next()`与`yield`的交互**：
   - `next()`返回一个对象`{ value, done }`：`value`是`yield`产出的值，`done`为布尔值（`true`表示生成器执行完毕）。
   - `yield`作为表达式可双向传递消息：`yield`向外发送值，`next()`可向暂停的`yield`传入值（第一个`next()`的参数会被忽略，因此时无暂停的`yield`）。
3. **生成器实例与并发**：
   - 每次通过生成器函数创建迭代器，均对应生成器的一个独立实例，实例间可独立运行甚至交互。

## 生成器产生值：生产者与迭代器

### 迭代器接口

- **作用**：定义从生产者逐步获取一系列值的标准接口，核心是`next()`方法。
- **`next()`返回值**：`{ done: boolean, value: any }`，`done`标识迭代是否结束，`value`为当前迭代值。

### `for..of`循环

- 自动迭代标准迭代器：每次循环调用`next()`，不传入参数，遇`done: true`自动停止。
- 支持内建可迭代对象：如数组（`array`）等内建数据结构默认实现迭代器，可直接用于`for..of`。

### Iterable（可迭代对象）

- **定义**：包含迭代器的对象，需实现`Symbol.iterator`方法（调用时返回一个新迭代器）。
- **`for..of`的依赖**：`for..of`循环期望操作可迭代对象，通过调用其`Symbol.iterator`获取迭代器。

### 生成器迭代器的特性

- 生成器执行后返回的迭代器兼具迭代器接口与生成器控制能力。
- **异常终止**：`for..of`因`break`、`return`或未捕获异常终止时，会向迭代器发送停止信号；可手动调用`it.return(value)`终止生成器，返回`{ value: 传入值, done: true }`。

## 异步迭代生成器

生成器可简化异步流程，将异步操作抽象为同步形式的代码：

```js
function foo(x, y) {
  ajax("http://...", (err, data) => {
    if (err) it.throw(err); // 向生成器抛错
    else it.next(data); // 向生成器传递异步结果
  });
}

function* main() {
  try {
    const text = yield foo(11, 31); // 暂停等待异步结果
    console.log(text);
  } catch (err) {
    console.error(err); // 捕获异步错误
  }
}

const it = main();
it.next(); // 启动生成器
```

- 上述代码中，`yield`等待异步操作`foo`完成，通过`it.next(data)`或`it.throw(err)`恢复执行，实现 “同步写法 + 异步执行”。

## 生成器与 Promise 的结合

- **优势**：生成器的 “同步化异步代码” 与 Promise 的 “可信任异步结果” 结合，是 ES6 中处理异步的理想模式。
- 实现方式：yield 产出一个 Promise，通过 Promise 的状态（完成 / 拒绝）控制生成器迭代器：
  - Promise 完成时，调用`it.next(结果值)`恢复生成器；
  - Promise 拒绝时，调用`it.throw(错误)`向生成器抛错。

## 生成器委托（`yield*`）

- **语法**：`yield* 迭代对象`（如`yield* foo()`，`foo`为生成器或其他可迭代对象）。
- **作用**：将迭代控制委托给另一个迭代器，暂停当前生成器的迭代控制，转由目标迭代器接管。
- **特性**：支持双向消息与错误传递（目标迭代器的`yield`与当前生成器的`next`/`throw`可交互）。

## 形实转换程序（Thunk）

- **定义**：JS 中的 thunk 指一个无参数函数，其作用是调用另一个函数（封装参数或逻辑）。
- **用途**：常用于简化函数调用，尤其是在异步流程中封装回调或参数，配合生成器使用可进一步简化异步代码。

## 补充说明

- 生成器的`yield`数量与`next()`调用次数关系：`next()`调用次数比`yield`语句多 1（最后一次`next()`用于获取`done: true`）。
- 生成器迭代器的独立性：同一生成器的多个实例（迭代器）互不干扰，可并发运行。
- `for..of`与迭代器的兼容性：仅支持符合 ES6 迭代器标准的对象（实现`Symbol.iterator`）。
