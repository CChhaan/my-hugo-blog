---
# 文章标题
title: 2.10 侦听器
# 文章内容摘要
# description:
# 文章内容关键字
keywords: Vue watch, Vue watchEffect, Vue 副作用, Vue 响应式侦听, Vue 深层侦听器, Vue immediate 选项, Vue once 侦听器, Vue flush post, Vue watchSyncEffect, Vue onWatcherCleanup, Vue 组合式 API 侦听
# 发表日期
date: 2025-04-11
summary: 本文主要介绍了 Vue 3 中的侦听器，包括侦听数据源类型、深层侦听器、即时回调的侦听器、一次性侦听器、`watchEffect()`、副作用清理、回调的触发时机、停止侦听器等内容。
# 分类
categories:
  - vue3文档阅读
# 标签
tags:
  - vue
  - vue3
  - 前端框架
  - 前端开发
---

## 计算属性与副作用

计算属性用于声明性地计算衍生值。但在某些情况下，需要在状态变化时执行**副作用**，例如：

- 更改 DOM
- 根据异步操作结果修改状态

在组合式 API 中，可以使用 `watch` 函数 在响应式状态发生变化时触发回调函数。

### 侦听数据源类型

`watch` 的第一个参数可以是：

- 一个 `ref`（包括计算属性）
- 一个响应式对象
- 一个 getter 函数
- 多个数据源组成的数组

**注意**：不能直接侦听响应式对象的属性值，需要用返回该属性的 getter 函数。

## 深层侦听器

直接传入响应式对象 → **隐式深层侦听器**（所有嵌套变更都会触发）。

返回响应式对象的 getter → **仅在返回不同对象时触发**。

可显式加上 `deep: true` 选项，强制为深层侦听器。

```js
watch(
  () => state.someObject,
  (newValue, oldValue) => {
    // newValue 和 oldValue 相等
    // 除非 state.someObject 被整个替换
  },
  { deep: true }
);
```

`deep` 可设为数字，表示最大遍历深度。

深度侦听会遍历所有嵌套属性，对大型数据结构开销大。**只在必要时使用，并注意性能**。

## 即时回调的侦听器

`watch` 默认懒执行，仅在数据源变化时回调。

使用 **`immediate: true`** 可在创建侦听器时立即执行回调。

## 一次性侦听器

默认：每次源变化时都会执行回调。

使用 **`once: true`** 可让回调仅执行一次。

## `watchEffect()`

用于简化依赖于相同响应式状态的侦听器。

**自动跟踪回调中的响应式依赖**，无需手动维护依赖列表。

对于嵌套数据结构，仅追踪被访问的属性，比深层侦听更高效。

**依赖追踪限制**：仅在同步执行期间生效。异步回调中，只有在第一个 `await` 之前访问到的属性会被追踪。

### `watch` vs. `watchEffect`

**`watch`**：

- 只追踪明确指定的数据源。
- 不追踪回调中访问的其他内容。
- 仅在数据源确实改变时触发回调。
- 可精确控制回调触发时机。

**`watchEffect`**：

- 在副作用执行期间追踪依赖。
- 自动追踪所有访问到的响应式属性。
- 更方便简洁，但依赖关系可能不够明确。

## 副作用清理

使用 `onWatcherCleanup()`注册清理函数，在侦听器失效并重新运行前调用。

**调用限制**：必须在 `watchEffect` 或 `watch` 回调的同步执行期间调用，不能在 `await` 之后调用。

替代方式：通过函数参数传递的 `onCleanup`，可在回调第三个参数或 `watchEffect` 回调的第一个参数中使用，不受同步限制。

## 回调的触发时机

当响应式状态变化时，可能同时触发：

- Vue 组件更新
- 侦听器回调

回调会**批量处理**，避免重复调用。

**默认时机**：在父组件更新之后、所属组件 DOM 更新之前调用。此时若在回调中访问 DOM，得到的是更新前的状态。

### Post Watchers

使用 **`flush: 'post'`** → 回调在组件 DOM 更新之后执行。

别名：`watchPostEffect()`。

### 同步侦听器

回调会在 Vue 更新之前立即触发。

别名：`watchSyncEffect()`。

特点：

- 不批处理。
- 每次响应式数据变化都会触发。
- 适合监视简单布尔值。
- **避免用于可能多次同步修改的数据源（如数组）**。

## 停止侦听器

在 `setup()` 或 `<script setup>` 中用同步语句创建的侦听器：

- 自动绑定到宿主组件。
- 在组件卸载时自动停止。

**关键点**：侦听器必须用同步语句创建。

- 如果在异步回调中创建 → 不会绑定到组件，需要手动停止，以防内存泄漏。

手动停止：调用 `watch` 或 `watchEffect` 返回的函数。

**建议**：尽量使用同步创建侦听器。若需异步数据，可使用条件式侦听逻辑。
