---
# 文章标题
title: 4.1 组合式函数
# 文章内容摘要
# description:
# 文章内容关键字
keywords: Vue 组合式函数, Composables, Vue 逻辑复用, Vue 组合式 API, use 函数命名, Vue 响应式状态管理, Vue 副作用处理, Vue setup 调用, Vue 与 Mixin 对比, Vue 无渲染组件
# 发表日期
date: 2025-04-16
summary: 本文主要介绍了 Vue 3 中的组合式函数，包括其定义、分类、约定和最佳实践，以及如何抽取组合式函数改善代码结构，并与选项式 API 和其他模式进行了比较。
# 分类
categories:
  - vue3文档阅读
# 标签
tags:
  - vue
  - vue3
  - 前端框架
  - 前端开发
  - 组件化开发
---

## 组合式函数

**组合式函数 (Composables)**：利用 Vue 的组合式 API 来封装和复用**有状态逻辑**的函数。

**无状态逻辑**：接收输入并立即返回输出，例如格式化时间函数。

**有状态逻辑**：负责管理随时间变化的状态。

**特点：**

- 核心逻辑与组件中一致，只是移到外部函数并返回需要暴露的状态。
- 在组合式函数中可以使用所有的 组合式 API。
- 组合式函数可以**嵌套调用**，像组件一样组合成更复杂的逻辑。

### 接收响应式状态

**`toValue()`**（Vue 3.3+）：将 ref 或 getter 规范化为值。

- 参数是 ref → 返回 ref 的值。
- 参数是函数 → 调用并返回函数结果。
- 否则 → 原样返回参数。

类似 `unref()`，但对函数有特殊处理。

## 约定和最佳实践

### 命名

使用驼峰命名法。**以 `use` 开头**。

### 输入参数

组合式函数可以接收 ref 或 getter 作为参数。

最佳实践：

- 使用 `toValue()` 处理参数。
- 如果函数内创建了响应式 effect：使用 `watch()` 监视 ref 或 getter，或在 `watchEffect()` 中调用 `toValue()`。

### 返回值

推荐返回一个包含多个 **ref** 的普通非响应式对象。

**原因：**保持解构后的响应性。若直接返回响应式对象，解构时会丢失响应性。

如果需要以对象属性形式使用状态，可以用 `reactive()` 包装返回对象。

### 副作用

可以执行副作用（DOM 事件监听、请求数据），但需遵守：

- SSR 应用中，必须在组件挂载后生命周期钩子中执行 DOM 相关副作用。
- 在 `onUnmounted()` 时清理副作用。

### 使用限制

只能在 `<script setup>` 或 `setup()` 中调用。

必须**同步调用**（可在生命周期钩子如 `onMounted()` 中调用）。

限制原因：需要访问活跃的组件实例上下文，以便：

1. 注册生命周期钩子。
2. 注册计算属性和监听器并在卸载时清理。

**特殊情况**：`<script setup>` 支持在 `await` 之后调用组合式函数，编译器会恢复组件实例。

## 抽取组合式函数改善代码结构

目的：不仅是复用，还能改善代码组织。

随着组件复杂度增加，组合式函数可以将逻辑拆分成更小的函数。

可以视作组件范围内的服务，相互之间可通信。

## 在选项式 API 中使用组合式函数

组合式函数必须在 `setup()` 中调用。返回的绑定也必须在 `setup()` 中返回，以暴露给 `this` 和模板。

## 与其他模式的比较

### 和 Mixin 的对比

Mixin 的三个短板：

- **数据来源不清晰**：难以追溯属性来源。
- **命名空间冲突**：多个 mixin 可能注册相同属性名。
- **隐式耦合**：通过共享属性名交互，导致隐性耦合。

**组合式函数的优势：**

- 属性来源清晰（ref + 解构模式）。
- 变量可在解构时重命名，避免冲突。
- 返回值可作为参数传递给其他组合式函数，像普通函数一样。

> **结论**：Vue 3 不推荐继续使用 mixin，仅保留用于迁移和兼容。

### 和无渲染组件的对比

**组合式函数**：不会产生额外的组件实例开销。

**无渲染组件**：在全局使用时，会带来明显的性能开销。

**推荐：**

逻辑复用 → 使用组合式函数。

逻辑 + 视图布局复用 → 使用无渲染组件。
