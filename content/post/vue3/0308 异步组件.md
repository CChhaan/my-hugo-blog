---
# 文章标题
title: 3.8 异步组件
# 文章内容摘要
# description:
# 文章内容关键字
keywords: Vue 异步组件, defineAsyncComponent, Vue 懒加载组件, Vue 代码分割, Vue 异步组件加载, Vue 加载状态, Vue 错误组件, Vue 惰性激活, Vue hydrateOnIdle, Vue hydrateOnVisible, Vue hydrateOnInteraction, Vue 异步组件策略
# 发表日期
date: 2025-04-12
summary: 本文主要介绍了 Vue 3 中异步组件的使用方法，包括基本用法、加载与错误状态、惰性激活等。通过使用异步组件，可以优化应用的加载性能，提高用户体验。
# 分类
categories:
  - Vue3文档阅读
# 标签
tags:
  - vue
  - vue3
  - 前端框架
  - 前端开发
  - 组件化开发
---

## 基本用法

在大型项目中，我们可能需要将应用拆分为更小的块，并仅在需要时再从服务器加载相关组件。Vue 提供了 **`defineAsyncComponent`** 方法来实现此功能。

`defineAsyncComponent` 接收一个返回 **Promise** 的加载函数：

- `resolve`：在从服务器获得组件定义时调用。
- `reject(reason)`：加载失败时调用。

ES 模块动态导入会返回 Promise，通常与 `defineAsyncComponent` 搭配使用。

构建工具（如 Vite、Webpack）支持动态导入，并会将其作为打包时的代码分割点，因此可用来导入 Vue 单文件组件。

**结果：**得到的组件是一个包装组件，仅在需要时才加载内部实际组件。

Props 和插槽会传递给内部组件，可以无缝替换原始组件。

异步组件与普通组件一样：

- 可以用 `app.component()` **全局注册**。
- 也可以在父组件中直接定义。

## 加载与错误状态

`defineAsyncComponent()` 支持高级选项来处理加载和错误状态：

```js
const AsyncComp = defineAsyncComponent({
  // 加载函数
  loader: () => import("./Foo.vue"),

  // 加载异步组件时使用的组件
  loadingComponent: LoadingComponent,
  // 展示加载组件前的延迟时间，默认为 200ms
  delay: 200,

  // 加载失败后展示的组件
  errorComponent: ErrorComponent,
  // 如果提供了一个 timeout 时间限制，并超时了
  // 也会显示这里配置的报错组件，默认值是：Infinity
  timeout: 3000,
});
```

**加载组件**：在内部组件加载时显示。默认延迟 **200ms** 才展示，避免网络良好时闪烁。

**报错组件**：在加载器函数的 Promise 抛错时渲染。超时后（如超过 `timeout` 设置）也会渲染。

## 惰性激活 (Vue 3.5+)

异步组件可以通过提供 **激活策略** 来控制何时进行激活。

- Vue 提供了内置激活策略，需要单独导入（便于 tree-shake）。
- 保持在底层设计，未来可在框架或上层解决方案中提供语法糖。

### 在空闲时进行激活

使用 `requestIdleCallback`

```js
import { defineAsyncComponent, hydrateOnIdle } from "vue";

const AsyncComp = defineAsyncComponent({
  loader: () => import("./Comp.vue"),
  hydrate: hydrateOnIdle(/* 传递可选的最大超时 */),
});
```

### 在可见时激活

使用 `IntersectionObserver`

```js
import { defineAsyncComponent, hydrateOnVisible } from "vue";

const AsyncComp = defineAsyncComponent({
  loader: () => import("./Comp.vue"),
  hydrate: hydrateOnVisible(),
});
```

可传递侦听器的选项对象。

### 在媒体查询匹配时进行激活

通过 **媒体查询** 控制

```js
import { defineAsyncComponent, hydrateOnMediaQuery } from "vue";

const AsyncComp = defineAsyncComponent({
  loader: () => import("./Comp.vue"),
  hydrate: hydrateOnMediaQuery("(max-width:500px)"),
});
```

### 交互时激活

在指定事件触发时激活

```js
import { defineAsyncComponent, hydrateOnInteraction } from "vue";

const AsyncComp = defineAsyncComponent({
  loader: () => import("./Comp.vue"),
  hydrate: hydrateOnInteraction("click"),
});
```

可以是多个事件类型的列表。

激活完成后，触发的事件会被**重放**。

### 自定义策略

通过自定义函数控制激活

```js
import { defineAsyncComponent, type HydrationStrategy } from "vue";

const myStrategy: HydrationStrategy = (hydrate, forEachElement) => {
  // forEachElement 是一个遍历组件未激活的 DOM 中所有根元素的辅助函数，
  // 因为根元素可能是一个片段而非单个元素
  forEachElement((el) => {
    // ...
  });
  // 准备好时调用 `hydrate`
  hydrate();
  return () => {
    // 如必要，返回一个销毁函数
  };
};

const AsyncComp = defineAsyncComponent({
  loader: () => import("./Comp.vue"),
  hydrate: myStrategy,
});
```
